# DittoFS Configuration - New Store-Per-Share Design
#
# This configuration demonstrates the new docker-compose-like approach where:
#   1. Stores are defined as named resources under metadata.stores and content.stores
#   2. Global settings apply to all stores of that type
#   3. Multiple shares can reference the same store instances
#   4. Maximum flexibility: mix-and-match stores per share

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  level: INFO          # DEBUG, INFO, WARN, ERROR
  format: text         # text or json
  output: stdout       # stdout, stderr, or file path

# =============================================================================
# Server Configuration
# =============================================================================
server:
  shutdown_timeout: 30s

  # Prometheus metrics
  metrics:
    enabled: false
    port: 9090

  # Global rate limiting (applies to all adapters unless overridden)
  rate_limiting:
    enabled: false
    requests_per_second: 5000
    burst: 10000

# =============================================================================
# Metadata Configuration
# =============================================================================
metadata:
  # Global settings that apply to all metadata stores
  global:
    # Filesystem capabilities - applies to all metadata stores
    filesystem_capabilities:
      max_read_size: 1048576        # 1MB
      preferred_read_size: 65536    # 64KB
      max_write_size: 1048576       # 1MB
      preferred_write_size: 65536   # 64KB
      max_file_size: 9223372036854775807  # 2^63-1
      max_filename_len: 255
      max_path_len: 4096
      max_hard_link_count: 32767
      supports_hard_links: true
      supports_symlinks: true
      case_sensitive: true
      case_preserving: true

    # DUMP operation restrictions - applies to all metadata stores
    dump_restricted: false
    dump_allowed_clients: []

  # Named metadata store instances
  stores:
    # In-memory metadata for fast temporary workloads
    memory-fast:
      type: memory
      memory: {}

    # BadgerDB for persistent metadata
    badger-main:
      type: badger
      badger:
        db_path: /tmp/dittofs-metadata-main

    # Separate BadgerDB instance for isolated shares
    badger-isolated:
      type: badger
      badger:
        db_path: /tmp/dittofs-metadata-isolated

# =============================================================================
# Content Configuration
# =============================================================================
content:
  # Global settings that apply to all content stores
  global:
    # Add any global content store settings here
    # For example: cache settings, compression, encryption

  # Named content store instances
  stores:
    # Local filesystem storage for fast access
    local-disk:
      type: filesystem
      filesystem:
        path: /tmp/dittofs-content

    # S3 storage for cloud-backed shares
    s3-production:
      type: s3
      s3:
        region: us-east-1
        bucket: dittofs-production
        key_prefix: ""
        endpoint: ""
        access_key_id: ""
        secret_access_key: ""
        part_size: 10485760  # 10MB

    # S3-compatible storage (e.g., MinIO, Cubbit)
    s3-archive:
      type: s3
      s3:
        region: us-east-1
        bucket: dittofs-archive
        endpoint: https://s3.example.com
        access_key_id: ${S3_ACCESS_KEY}      # Environment variable expansion
        secret_access_key: ${S3_SECRET_KEY}
        part_size: 52428800  # 50MB for large files

    # In-memory storage for caching/testing
    memory-cache:
      type: memory
      memory: {}

# =============================================================================
# Share/Export Definitions
# =============================================================================
# Each share explicitly references its metadata and content stores by name.
# Multiple shares can reference the same store instances for resource sharing.
shares:
  # Fast local share using in-memory metadata and local disk
  - name: /fast
    metadata_store: memory-fast
    content_store: local-disk
    read_only: false
    async: true

    # Access control
    allowed_clients: []
    denied_clients: []

    # Authentication
    require_auth: false
    allowed_auth_methods: [anonymous, unix]

    # Identity mapping
    identity_mapping:
      map_all_to_anonymous: true
      map_privileged_to_anonymous: false
      anonymous_uid: 65534
      anonymous_gid: 65534

    # Root directory attributes
    root_attr:
      mode: 0755
      uid: 0
      gid: 0

  # Cloud-backed share with persistent metadata
  - name: /cloud
    metadata_store: badger-main
    content_store: s3-production
    read_only: false
    async: false

    allowed_clients: []
    denied_clients: []
    require_auth: false
    allowed_auth_methods: [anonymous, unix]

    identity_mapping:
      map_all_to_anonymous: false
      map_privileged_to_anonymous: true
      anonymous_uid: 65534
      anonymous_gid: 65534

    root_attr:
      mode: 0755
      uid: 0
      gid: 0

  # Archive share with S3-compatible storage
  - name: /archive
    metadata_store: badger-main      # Shares metadata with /cloud
    content_store: s3-archive        # Different content backend
    read_only: false
    async: false

    allowed_clients: []
    denied_clients: []
    require_auth: false
    allowed_auth_methods: [anonymous, unix]

    identity_mapping:
      map_all_to_anonymous: true
      map_privileged_to_anonymous: false
      anonymous_uid: 65534
      anonymous_gid: 65534

    root_attr:
      mode: 0755
      uid: 0
      gid: 0

  # Isolated share with separate metadata store
  - name: /isolated
    metadata_store: badger-isolated  # Completely isolated metadata
    content_store: local-disk        # Shares content with /fast
    read_only: false
    async: true

    allowed_clients: [192.168.1.0/24]
    denied_clients: []
    require_auth: false
    allowed_auth_methods: [unix]

    identity_mapping:
      map_all_to_anonymous: false
      map_privileged_to_anonymous: true
      anonymous_uid: 65534
      anonymous_gid: 65534

    root_attr:
      mode: 0700
      uid: 1000
      gid: 1000

  # Temporary cache share using memory for both
  - name: /cache
    metadata_store: memory-fast      # Shares metadata with /fast
    content_store: memory-cache
    read_only: false
    async: true

    allowed_clients: []
    denied_clients: []
    require_auth: false
    allowed_auth_methods: [anonymous]

    identity_mapping:
      map_all_to_anonymous: true
      map_privileged_to_anonymous: false
      anonymous_uid: 65534
      anonymous_gid: 65534

    root_attr:
      mode: 0777
      uid: 0
      gid: 0

# =============================================================================
# Protocol Adapters
# =============================================================================
adapters:
  nfs:
    enabled: true
    port: 2049
    max_connections: 0

    # Timeout configuration
    timeouts:
      read: 5m
      write: 30s
      idle: 5m
      shutdown: 30s

    metrics_log_interval: 5m

# =============================================================================
# Garbage Collection Configuration
# =============================================================================
gc:
  enabled: true
  interval: 24h
  timeout: 10m
  batch_size: 1000
  dry_run: false

# =============================================================================
# Configuration Patterns & Use Cases
# =============================================================================

# Pattern 1: Shared Metadata Store
#   /cloud and /archive both use badger-main
#   They share the same metadata database and see each other's files

# Pattern 2: Performance Tiering
#   /fast: memory-fast + local-disk (fastest)
#   /cloud: badger-main + s3-production (persistent)
#   /archive: badger-main + s3-archive (archival)
#   /cache: memory-fast + memory-cache (ephemeral)

# Pattern 3: Isolation
#   /isolated uses badger-isolated
#   Completely separate metadata from other shares

# Pattern 4: Shared Content, Isolated Metadata
#   /fast and /isolated both use local-disk for content
#   But have separate metadata stores

# =============================================================================
# Migration from Old Configuration
# =============================================================================
#
# Old format:
#   content:
#     type: filesystem
#     filesystem:
#       path: /tmp/content
#   metadata:
#     type: memory
#     filesystem_capabilities: {...}
#   shares:
#     - name: /export
#
# New format:
#   metadata:
#     global:
#       filesystem_capabilities: {...}
#     stores:
#       default:
#         type: memory
#   content:
#     stores:
#       default:
#         type: filesystem
#         filesystem:
#           path: /tmp/content
#   shares:
#     - name: /export
#       metadata_store: default
#       content_store: default
